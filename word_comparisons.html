<!DOCTYPE html>
<meta charset="utf-8">
<meta title="austenmania, viz 1">

<style>

body {
   font-family: "Georgia";
}

line {
  stroke: silver !important;
}

.grid line,
.grid path {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

[class*="bar-chart-container"] {
   display: flex;
   flex-direction: row;
}

[class*="bar-chart-container-dropdown"] {
   display: flex;
   flex-direction: row;
}
[class*="bar-chart-dropdown"] {
   font-size: 16px;
   font-family: "Georgia";
   font-weight: bold;
   width: 300px;
   text-align-last: center;
}

.bar-chart-dropdown-spacer {
   font-size: 14px;
   width: 158px;
}

[class*="bar-chart-words-container"] {
   text-align: center;
   background-color: lightgrey;
   border: 1px solid gray;
   width: 150px;

   display: flex;
   flex-direction: column;
   justify-content: space-between;
   align-items: center;
   padding-top: 3px;
   padding-bottom: 5px;
}

.bar-chart-words {
   font-size: 14px;
   font-family: "Georgia";
   text-align-last: center;
   width: 95%;
}

.bar-chart-words-message {
   font-size: 12px;
   font-style: italic;
}

.bar-chart-button {
   font-size: 14px;
   font-family: "Georgia";
   font-weight: bold;
   text-align-last: center;
   width: 90%;
}

</style>

<body>
<div>
   <h3>austenmania</h3>
</div>
<script src="https://d3js.org/d3.v6.min.js"></script>

<div>
   <h3>The bar chart section</h3>
   
   <!--I acknowledge that this is not a neat solution, in d3 or html/css; 
      I added 3 diverging bar chart units into html with pre-made svgs to initialize divs +
      to reduce error from integrating search term functionality in the center
      i.e. experimenting with the design, up to the deadline
      TODO: clean up code style, port over to React to reuse components-->
   <div class="bar-chart-container-dropdown-1">
      <select class="bar-chart-dropdown" id="bar-chart-dropdown-1a">
         <option value=0>Sense and Sensibility</option>
         <option value=1 selected=1>Pride and Prejudice</option>
         <option value=2>Northanger Abbey</option>
         <option value=3>Mansfield Park</option>
         <option value=4>Emma</option>
         <option value=5>Persuasion</option>
         <option value=6>All novels</option>
      </select>
      <span class="bar-chart-dropdown-spacer">Terms</span>
      <select class="bar-chart-dropdown" id="bar-chart-dropdown-1b">
         <option value="0">Sense and Sensibility</option>
         <option value="1">Pride and Prejudice</option>
         <option value="2">Northanger Abbey</option>
         <option value="3">Mansfield Park</option>
         <option value="4">Emma</option>
         <option value="5">Persuasion</option>
         <option value="6" selected=6>All novels</option>
      </select>
   </div>

   <div class="bar-chart-container-1">
      <svg id="bar-chart-svg-1a"> </svg>
         <div class="bar-chart-words-container-1"><span class="bar-chart-words-message">Select and enter new terms, then hit update all</span>
            <input type="text" value="marriage" class="bar-chart-words" id="bar-chart-words-1-0">
            <input type="text" value="estate" class="bar-chart-words" id="bar-chart-words-1-1">
            <input type="text" value="money" class="bar-chart-words" id="bar-chart-words-1-2">
            <input type="text" value="letter" class="bar-chart-words" id="bar-chart-words-1-3">
            <input type="text" value="family" class="bar-chart-words" id="bar-chart-words-1-4">
            <button type="button" class="bar-chart-button" id="bar-chart-word-search-button-1" onclick="searchKeywordsOnClick1()">Update all</button> 
         </div>
      <svg id="bar-chart-svg-1b"> </svg>
   </div>

   <div class="bar-chart-container-dropdown-2">
      <select class="bar-chart-dropdown" id="bar-chart-dropdown-2a">
         <option value=0 selected=0>Sense and Sensibility</option>
         <option value=1>Pride and Prejudice</option>
         <option value=2>Northanger Abbey</option>
         <option value=3>Mansfield Park</option>
         <option value=4>Emma</option>
         <option value=5>Persuasion</option>
         <option value=6>All novels</option>
      </select>
      <span class="bar-chart-dropdown-spacer">Terms</span>
      <select class="bar-chart-dropdown" id="bar-chart-dropdown-2b">
         <option value="0">Sense and Sensibility</option>
         <option value="1">Pride and Prejudice</option>
         <option value="2">Northanger Abbey</option>
         <option value="3" selected=3>Mansfield Park</option>
         <option value="4">Emma</option>
         <option value="5">Persuasion</option>
         <option value="6">All novels</option>
      </select>
   </div>
   <div class="bar-chart-container-2">
      <svg id="bar-chart-svg-2a"> </svg>
         <div class="bar-chart-words-container-2"><span class="bar-chart-words-message">Select and enter new terms, then hit update all</span>
            <input type="text" value="marriage" class="bar-chart-words" id="bar-chart-words-2-0">
            <input type="text" value="parsonage" class="bar-chart-words" id="bar-chart-words-2-1">
            <input type="text" value="cousins" class="bar-chart-words" id="bar-chart-words-2-2">
            <input type="text" value="sisters" class="bar-chart-words" id="bar-chart-words-2-3">
            <input type="text" value="engagement" class="bar-chart-words" id="bar-chart-words-2-4">
            <button type="button" class="bar-chart-button" id="bar-chart-word-search-button-2" onclick="searchKeywordsOnClick2()">Update all</button> 
         </div>
      <svg id="bar-chart-svg-2b"> </svg>
   </div>

   <div class="bar-chart-container-dropdown-3">
      <select class="bar-chart-dropdown" id="bar-chart-dropdown-3a">
         <option value=0>Sense and Sensibility</option>
         <option value=1>Pride and Prejudice</option>
         <option value=2>Northanger Abbey</option>
         <option value=3>Mansfield Park</option>
         <option value=4>Emma</option>
         <option value=5 selected=5>Persuasion</option>
         <option value=6>All novels</option>
      </select>
      <span class="bar-chart-dropdown-spacer">Terms</span>
      <select class="bar-chart-dropdown" id="bar-chart-dropdown-3b">
         <option value="0">Sense and Sensibility</option>
         <option value="1">Pride and Prejudice</option>
         <option value="2" selected=2>Northanger Abbey</option>
         <option value="3">Mansfield Park</option>
         <option value="4">Emma</option>
         <option value="5">Persuasion</option>
         <option value="6">All novels</option>
      </select>
   </div>

   <div class="bar-chart-container-3">
      <svg id="bar-chart-svg-3a"> </svg>
         <div class="bar-chart-words-container-3"><span class="bar-chart-words-message">Select and enter new terms, then hit update all</span>
            <input type="text" value="marriage" class="bar-chart-words" id="bar-chart-words-3-0">
            <input type="text" value="letter" class="bar-chart-words" id="bar-chart-words-3-1">
            <input type="text" value="love" class="bar-chart-words" id="bar-chart-words-3-2">
            <input type="text" value="friend" class="bar-chart-words" id="bar-chart-words-3-3">
            <input type="text" value="go" class="bar-chart-words" id="bar-chart-words-3-4">
            <button type="button" class="bar-chart-button" id="bar-chart-word-search-button-3" onclick="searchKeywordsOnClick3()">Update all</button> 
         </div>
      <svg id="bar-chart-svg-3b"> </svg>
   </div>


</div>
<!--Note: Needed to place the interactive button / input elements directly before d3 script to work-->

<script>

   ////*HTML button helper, outside d3 file sharing*////
   let selectedKeywordsBarChart = [
      ["marriage", "estate", "money", "letter", "family"],
      ["marriage", "parsonage", "cousins", "sisters", "engagement"],
      ["marriage", "letter", "love", "friend", "go"]
      ];
   let currBarChartId = 0;
   
   const numKeywords = 5;
   const numBarCharts = 3;
   function searchKeywordsOnClick1() {
      for(let i=0; i < numKeywords; i++) {
         selectedKeywordsBarChart[0][i] = document.getElementById(`bar-chart-words-1-${i}`).value.toLowerCase();
      }
      currBarChartId = 0;
   }
   function searchKeywordsOnClick2() {
      for(let i=0; i < numKeywords; i++) {
         selectedKeywordsBarChart[1][i] = document.getElementById(`bar-chart-words-2-${i}`).value.toLowerCase();
      }
      currBarChartId = 1;
   }
   function searchKeywordsOnClick3() {
      for(let i=0; i < numKeywords; i++) {
         selectedKeywordsBarChart[2][i] = document.getElementById(`bar-chart-words-3-${i}`).value.toLowerCase();
      }
      currBarChartId = 2;
   }

Promise.all([
    d3.csv("/word_counts/Austen_SenseAndSensibility_count.csv"),
    d3.csv("/word_counts/Austen_PrideAndPrejudice_count.csv"),
    d3.csv("/word_counts/Austen_NorthangerAbbey_count.csv"),
    d3.csv("/word_counts/Austen_MansfieldPark_count.csv"),
    d3.csv("/word_counts/Austen_Emma_count.csv"),
    d3.csv("/word_counts/Austen_Persuasion_count.csv"),
    d3.csv("/word_counts/Austen_Combined_count.csv"),
]).then(function(nestedDataList) {
////*Set-up, constants, global vars, and functions*////
   const titles = ["Sense and Sensibility", "Pride and Prejudice", "Northanger Abbey", "Mansfield Park", "Emma", "Persuasion", "All"];
   const word_count_numbers = [{count: 120000, divider: 12}, {count: 122000, divider: 12.2}, {count: 77000, divider: 7.7}, {count: 160000, divider: 16}, {count: 161000, divider: 16.1}, {count: 83000, divider: 8.3}, {count: 723000, divider: 72.3}]; //rounded to nearest 1000 for text-processing error
   
   const sense_and_sensibility_words = nestedDataList[0];
   const pride_and_prejudice_words = nestedDataList[1];
   const northanger_abbey_words = nestedDataList[2];
   const mansfield_park_words = nestedDataList[3];
   const emma_words = nestedDataList[4];
   const persuasion_words = nestedDataList[5];
   const combined_words = nestedDataList[6];

   const plotVars = ({
      plotWidth: 300,   // Width of plot region
      plotHeight: 260,  // Height of plot region
      plotMargin: 15,   // Margin space for axes and their labels
      plotMarginTop: 35,   // Margin space for axes and their labels
      plotMarginBottom: 30   // Margin space for axes and their labels
   });

   violet_red_colors = ["#EF224B", "red", "#C20032", "deeppink", "#c71585"];

   d3.select(`#bar-chart-word-search-button-1`).on("click", function() {
      updateFunction(currBarChartId);
   });
   d3.select(`#bar-chart-word-search-button-2`).on("click", function() {
      updateFunction(currBarChartId);
   });
   d3.select(`#bar-chart-word-search-button-3`).on("click", function() {
      updateFunction(currBarChartId);
   });

////*Update function*////
   function updateFunction(currBarChartId) {
//Todo: refactor into smaller chunks, ah well it works for right now; error checking
      numId = currBarChartId+1;
      //Redefine constants, oops numId is really the bar chart 1, 2, or 3; subtract 1 for array searching
      let leftIndex = document.getElementById(`bar-chart-dropdown-${numId}a`).value;
      leftData = nestedDataList[leftIndex];

      let rightIndex = document.getElementById(`bar-chart-dropdown-${numId}b`).value;
      rightData = nestedDataList[rightIndex];

      //Look up and fill in values from word frequency file
      let leftChartVals = [];
      let rightChartVals = [];
      for(let i=0; i < numKeywords; i++) {
         let wordToFindLeft = selectedKeywordsBarChart[numId-1][i];
         let wordToFindRight = selectedKeywordsBarChart[numId-1][i];

         let foundWordLeft = leftData.filter(obj => obj.word === wordToFindLeft)[0];
         let foundWordRight = rightData.filter(obj => obj.word === wordToFindRight)[0];

         if(foundWordLeft) {
            let freqPer10k = parseFloat(foundWordLeft.frequency) / parseFloat(word_count_numbers[leftIndex].divider);
            leftChartVals[i] = {"key": i, "value": freqPer10k };
         } else {
            leftChartVals[i] = 0;
         }
         if(foundWordRight) {
            let freqPer10k = parseFloat(foundWordRight.frequency) / parseFloat(word_count_numbers[rightIndex].divider);
            rightChartVals[i] = {"key": i, "value": freqPer10k };
         } else {
            rightChartVals[i] = 0;
         }
      }

      //redefine the xscales...
      let xMax = Math.ceil(Math.max(d3.max(leftChartVals, d => d.value), d3.max(rightChartVals, d=> d.value))); //use same baseline for comparison
      let xScaleA = d3.scaleLinear()
        .domain([0, xMax])
        .range([plotVars.plotWidth, plotVars.plotMargin])

      let yScaleA = d3.scaleBand()
        .domain(leftChartVals.map(d => d.key)) //Per # of terms
        .range([plotVars.plotMarginTop, plotVars.plotHeight - plotVars.plotMarginBottom - 2]); //plot top to bottom
      
      let xScaleB = d3.scaleLinear()
        .domain([0, xMax])
        .range([0, plotVars.plotWidth - plotVars.plotMargin])

      let yScaleB = d3.scaleBand()
        .domain(rightChartVals.map(d => d.key)) //Per # of terms
        .range([plotVars.plotMarginTop, plotVars.plotHeight - plotVars.plotMarginBottom - 2]); //plot top to bottom
      
      //Redraw svg containers
      let leftSvgContainer = d3.select(`#bar-chart-svg-${numId}a`);
      let rightSvgContainer = d3.select(`#bar-chart-svg-${numId}b`);
      
      //redraw the rects for the left
      leftSvgContainer.selectAll("rect")
         .data(leftChartVals)
         .join("rect")
         .attr("id", function(arrayVal, index) {
            return `bar-chart-svg-${numId}a-${index}`;
         })
         .attr("x", function(arrayVal) { 
            return xScaleA(arrayVal.value);
         })
         .attr("y", arrayVal => yScaleA(arrayVal.key))
         .attr("width", function(arrayVal) {
            let width = xScaleA(0) - xScaleA(arrayVal.value); 
            if(width) return width;
            else {
               return 0; //falsy updates
            }
         })
         .attr("height", yScaleA.bandwidth())  // <-- Band scales split a pixel range into equal-sized bands
         .style("fill", arrayVal => violet_red_colors[arrayVal.key])
         .style("opacity", 0.85)         
         .style("stroke", "white");

      //redraw the rects for the right
      rightSvgContainer.selectAll("rect")
         .data(rightChartVals)
         .join("rect")
         .attr("id", function(arrayVal, index) {
            return `bar-chart-svg-${numId}b-${index}`;
         })
         .attr("x", 0)
         .attr("y", arrayVal => yScaleB(arrayVal.key))
         .attr("width", function(arrayVal) {
            let width = xScaleB(arrayVal.value); 
            if(width) return width;
            else {
               return 0; //falsy updates
            }
         })
         .attr("height", yScaleB.bandwidth())  // <-- Band scales split a pixel range into equal-sized bands
         .style("fill", arrayVal => violet_red_colors[arrayVal.key])
         .style("opacity", 0.85)         
         .style("stroke", "white");

      let xAxisA = d3.axisBottom(xScaleA);
      let xAxisB = d3.axisBottom(xScaleB);
      //transition scales
      leftSvgContainer.select(`.bar-chart-x-axis-${numId}a`)
      .attr('transform', `translate(0, ${plotVars.plotHeight - plotVars.plotMarginBottom})`)
      .transition(0.8)
      .call(xAxisA);

      rightSvgContainer.select(`.bar-chart-x-axis-${numId}b`)
      .attr('transform', `translate(0, ${plotVars.plotHeight - plotVars.plotMarginBottom})`)
      .transition(0.8)
      .call(xAxisB);
   };
   

////*Rendering portion*////
   function initializeSingleRender(numId) {
      //Redefine constants, oops numId is really the bar chart 1, 2, or 3; subtract 1 for array searching
      let leftIndex = document.getElementById(`bar-chart-dropdown-${numId}a`).value;
      leftData = nestedDataList[leftIndex];

      let rightIndex = document.getElementById(`bar-chart-dropdown-${numId}b`).value;
      rightData = nestedDataList[rightIndex];

      //Look up and fill in values from word frequency file
      let leftChartVals = [];
      let rightChartVals = [];
      for(let i=0; i < numKeywords; i++) {
         let wordToFindLeft = selectedKeywordsBarChart[numId-1][i];
         let wordToFindRight = selectedKeywordsBarChart[numId-1][i];

         let foundWordLeft = leftData.filter(obj => obj.word === wordToFindLeft)[0];
         let foundWordRight = rightData.filter(obj => obj.word === wordToFindRight)[0];

         if(foundWordLeft) {
            let freqPer10k = parseFloat(foundWordLeft.frequency) / parseFloat(word_count_numbers[leftIndex].divider);
            leftChartVals[i] = {"key": i, "value": freqPer10k };
         } else {
            leftChartVals[i] = 0;
         }
         if(foundWordRight) {
            let freqPer10k = parseFloat(foundWordRight.frequency) / parseFloat(word_count_numbers[rightIndex].divider);
            rightChartVals[i] = {"key": i, "value": freqPer10k };
         } else {
            rightChartVals[i] = 0;
         }
      }

      let xMax = Math.ceil(Math.max(d3.max(leftChartVals, d => d.value), d3.max(rightChartVals, d=> d.value))); //use same baseline for comparison
      let xScaleA = d3.scaleLinear()
        .domain([0, xMax])
        .range([plotVars.plotWidth, plotVars.plotMargin])

      let yScaleA = d3.scaleBand()
        .domain(leftChartVals.map(d => d.key)) //Per # of terms
        .range([plotVars.plotMarginTop, plotVars.plotHeight - plotVars.plotMarginBottom - 2]); //plot top to bottom
      
      let xScaleB = d3.scaleLinear()
        .domain([0, xMax])
        .range([0, plotVars.plotWidth - plotVars.plotMargin])

      let yScaleB = d3.scaleBand()
        .domain(rightChartVals.map(d => d.key)) //Per # of terms
        .range([plotVars.plotMarginTop, plotVars.plotHeight - plotVars.plotMarginBottom - 2]); //plot top to bottom
      
      //Redraw svg containers
      let leftSvgContainer = d3.select(`#bar-chart-svg-${numId}a`)
      .attr("width", plotVars.plotWidth)
      .attr("height", plotVars.plotHeight)
      .style("background-color", "whitesmoke")
      .style("border", "1px solid gray")
            //insert grid lines on mouseover
      .on("mouseover", function (d, i) {
         d3.select(`.bar-chart-x-axis-grid-${numId}a`).transition()
         .style("opacity", "0.8")
      })
      .on("mouseout", function (d, i) {
            d3.select(`.bar-chart-x-axis-grid-${numId}a`).transition()
            .style("opacity", "0")
      });

      let rightSvgContainer = d3.select(`#bar-chart-svg-${numId}b`)
         .attr("width", plotVars.plotWidth)
         .attr("height", plotVars.plotHeight)
         .style("background-color", "whitesmoke")
         .style("border", "1px solid gray")
         //insert grid lines on mouseover
         .on("mouseover", function (d, i) {
            d3.select(`.bar-chart-x-axis-grid-${numId}b`).transition()
            .style("opacity", "0.8")
         })
         .on("mouseout", function (d, i) {
            d3.select(`.bar-chart-x-axis-grid-${numId}b`).transition()
            .style("opacity", "0")
      });
      
      //draw the rects for the left
      leftSvgContainer.selectAll("rect")
         .data(leftChartVals)
         .join("rect")
         .attr("id", function(arrayVal) {
            return `bar-chart-svg-${numId}a-${arrayVal.key}`;
         })
         .attr("x", arrayVal => xScaleA(arrayVal.value))
         .attr("y", arrayVal => yScaleA(arrayVal.key))
         .attr("width", function(arrayVal) {
            return xScaleA(0) - xScaleA(arrayVal.value); 
         })
         .attr("height", yScaleA.bandwidth())  // <-- Band scales split a pixel range into equal-sized bands
         .style("fill", arrayVal => violet_red_colors[arrayVal.key])
         .style("opacity", 0.85)
         .style("stroke", "white");

      //draw the rects for the right
      rightSvgContainer.selectAll("rect")
         .data(rightChartVals)
         .join("rect")
         .attr("id", function(arrayVal) {
            return `bar-chart-svg-${numId}b-${arrayVal.key}`;
         })
         .attr("x", 0)
         .attr("y", arrayVal => yScaleB(arrayVal.key))
         .attr("width", function(arrayVal) {
            return xScaleB(arrayVal.value); 
         })
         .attr("height", yScaleB.bandwidth())  // <-- Band scales split a pixel range into equal-sized bands
         .style("fill", arrayVal => violet_red_colors[arrayVal.key])
         .style("opacity", 0.85)
         .style("stroke", "white");
      
      drawTicks(leftSvgContainer, rightSvgContainer, xScaleA, xScaleB, numId);
   }

   function drawTicks(leftPlotContainer, rightPlotContainer, xScaleA, xScaleB, numId) {
      //Static tick-making and explainers
      let xAxisA = d3.axisBottom(xScaleA);
      let xAxisB = d3.axisBottom(xScaleB);

      let xAxisAGrid = d3.axisBottom(xScaleA).tickSize(-(plotVars.plotHeight)).tickFormat("").ticks(12);
      let xAxisBGrid = d3.axisBottom(xScaleB).tickSize(-(plotVars.plotHeight)).tickFormat("").ticks(12);

      leftPlotContainer.append("g")
         .attr("class", `bar-chart-x-axis-${numId}a`)
         .attr('transform', `translate(0, ${plotVars.plotHeight - plotVars.plotMarginBottom})`)
         .style("font-family", "Georgia")
         .call(xAxisA);

      rightPlotContainer.append("g")
         .attr("class", `bar-chart-x-axis-${numId}b`)
         .attr('transform', `translate(0, ${plotVars.plotHeight - plotVars.plotMarginBottom})`)
         .style("font-family", "Georgia")
         .call(xAxisB);
      
      leftPlotContainer.append("g")
         .attr("class", `bar-chart-x-axis-grid-${numId}a`)
         .attr("transform", `translate(0, ${plotVars.plotHeight})`)
         .style("opacity", 0)
         .call(xAxisAGrid);
      
      rightPlotContainer.append("g")
         .attr("class", `bar-chart-x-axis-grid-${numId}b`)
         .attr("transform", `translate(0, ${plotVars.plotHeight})`)
         .style("opacity", 0)
         .call(xAxisBGrid);

      leftPlotContainer.append("text")
         .attr("y", plotVars.plotHeight - 3)
         .attr("x", plotVars.plotWidth / 2)
         .style("font-family", "Georgia")
         .style("font-size", 11)
         .style("text-anchor", "middle")
         .text("Term frequency per 10K words");
      
      rightPlotContainer.append("text")
         .attr("y", plotVars.plotHeight - 3)
         .attr("x", plotVars.plotWidth / 2)
         .style("font-family", "Georgia")
         .style("font-size", 11)
         .style("text-anchor", "middle")
         .text("Term frequency per 10K words");
   };
      

   for(let i=1; i <= 3; i++) {
      initializeSingleRender(i);
   }
});

</script>

</body>
</html>