<!DOCTYPE html>
<meta charset="utf-8">
<meta title="austenmania, viz 1">

<style>

line {
  stroke: silver !important;
}

.grid line,
.grid path {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

</style>

<body>
<div>
   <h3>austenmania</h3>
</div>
<script src="https://d3js.org/d3.v6.min.js"></script>

<input type="text" value="marriage" id="keywordSearch">
<button type="button" id="keywordSearchButton" onclick="searchKeywordOnClick()">Search for a term</button> 
<div>
   <p>Paragraphs containing term: <span id="p-num-paragraphs-keyword"></span></p>
   <p>Overall word frequency:  <span id="p-keyword-frequency"></span>
</div>
<!--Note: Needed to place the interactive button / input elements directly before d3 script to work-->

<script>

   ////*HTML button helper, outside d3 file sharing*////
   let selectedKeyword = keywordSearch.value;
   function searchKeywordOnClick() {
      selectedKeyword = keywordSearch.value.toLowerCase();
   }

d3.json("/character_occurrences/Austen_Combined_character_occurrences.json").then(function(nestedDataList) { 

////*Set-up, constants, global vars, and functions*////
   const titles = ["Sense and Sensibility (begun 1795)", "Pride and Prejudice (bg. 1797)", "Northanger Abbey (bg. 1799)", "Mansfield Park (bg. 1811)", "Emma (bg. 1814)", "Persuasion (bg. 1815)"];
   
   const sense_and_sensibility_char = nestedDataList[0];
   const pride_and_prejudice_char = nestedDataList[1];
   const northanger_abbey_char = nestedDataList[2];
   const mansfield_park_char = nestedDataList[3];
   const emma_char = nestedDataList[4];
   const persuasion_char = nestedDataList[5];

   //Temporary until I implement toggle-able switching
   let nestedData = []; //pride_and_prejudice_nested_paragraphs;

   const plotVars = ({
      plotWidth: 630,   // Width of plot region
      plotHeight: 500,  // Height of plot region
      plotMargin: 30,   // Margin space for axes and their labels
      plotMarginLeft: 60   // Margin space for axes and their labels
   });

   rainbow_colors = ["ff0000", "f57f17", "ffd600", "ide4bd", "19aade", "142459", "7d3ac1", "cc0099", "663300", "ff99ff", "9e9e9e"];
   
   let numParagraphsWithKeyword = 0;
   let numKeywordFrequency = 0;
   function containsWord(paragraph, word) {
      let regexp = new RegExp(`\\b${word}\\b`, "gi"); //\\b + word + \\b for word + escapes, use global search and i for keyword frequency
      
      paragraphMatches = paragraph.match(regexp);
      if(paragraphMatches != null) {
         numKeywordFrequency += paragraph.match(regexp).length;
         return true;
      }
      return false;
   }

   function drawTicks(plotContainer, yAxisGrid, yAxis, xAxis, id) {
      plotContainer.append("g")
         .attr("class", `y-axis-grid-${id}`)
         .attr("transform", `translate(${plotVars.plotMarginLeft - plotVars.plotMargin/2 }, 0)`)
         .style("opacity", 0)
         .call(yAxisGrid);
      
      plotContainer.append("g")
         .attr("class", `y-axis-${id}`)
         .attr("transform", `translate(${plotVars.plotMargin*1.5}, 0)`)
         .style("font-family", "Georgia")
         .call(yAxis);
      
      plotContainer.append("g")
         .attr("class", `x-axis-${id}`)
         .attr('transform', `translate(0,${ plotVars.plotHeight - plotVars.plotMargin })`)
         .style("font-family", "Georgia")
         .call(xAxis);

      plotContainer.append("text")
         .attr("y", plotVars.plotHeight / 3)
         .attr("x", 10)
         .attr("style", "writing-mode: tb; glyph-orientation-vertical: 90")
         .attr("dy", "1em")
         .style("font-family", "Georgia")
         .style("font-size", 12)
         .style("text-anchor", "middle")
         .text("Character Mentions per Chapter");
      
      plotContainer.append("text")
         .attr("y", 14)
         .attr("x", (plotVars.plotWidth + plotVars.plotMargin) / 2)
         .attr("dy", "1em")
         .style("font-family", "Georgia")
         .style("font-size", 16)
         .style("text-anchor", "middle")
         .text(function() {
            title_id = id[id.length - 1];
            return titles[title_id];
         });

   };
      
////*Search function*////
   let keywordSearchBar = document.getElementById("keywordSearch");
   keywordSearchBar.addEventListener("keyup", function(event) {
   // Number 13 is the "Enter" key on the keyboard
   if (event.keyCode === 13) {
      event.preventDefault();
      // Trigger the button element with a click
      document.getElementById("keywordSearchButton").click();
   }
   });

   d3.select("#keywordSearchButton").on("click", function() {
         //reset counters for next search
         numParagraphsWithKeyword = 0;
         numKeywordFrequency = 0

         d3.selectAll("rect")
         .attr("fill", function(paragraph) { //d3 still saves the .each binding of each rect to paragraph, gosh I love it when things work 
            if(containsWord(paragraph.toLowerCase(), selectedKeyword)) {
               numParagraphsWithKeyword++;
               return "hotpink";    
            } else {
               return "forestgreen";
            }
         })

         d3.select("#p-num-paragraphs-keyword")
         .text(numParagraphsWithKeyword)

         d3.select("#p-keyword-frequency")
         .text(numKeywordFrequency)
   });

////*Rendering portion*////
   function initializeSingleRender(id, nestedDataLocal) {
      //Redefine constants
      nestedData = nestedDataLocal;
      let xScale = d3.scaleLinear(nestedData)
        .domain([0, nestedData[0].values.length])
        .range([plotVars.plotMargin, plotVars.plotWidth - plotVars.plotMargin])

      let yScale = d3.scaleLinear(nestedData)
        .domain([0, 60]) //Keep consistent across novels
        .range([plotVars.plotMargin, plotVars.plotHeight - plotVars.plotMargin].reverse());
      
      let lineGenerator = d3.line()
         .x(values => xScale(values.chapter)/* Fill in */) // year_month should go on the x-axis, and apparently need to turn into new Date for functionality
         .y(values => yScale(values.count)/* Fill in */); // screen_time_seconds should go on the y-axis

      //Static tick-making and explainers
      let xAxis = d3.axisBottom(xScale);
      let yAxis = d3.axisLeft(yScale);
      let yAxisGrid = d3.axisLeft(yScale).tickSize(-(plotVars.plotWidth + plotVars.plotMargin/2)).tickFormat("").ticks(12);
         
      //Add svg container
      let svgContainer = d3.select("body")
      .append("svg")
      .attr("id", `svg-${id}`)
      .attr("width", plotVars.plotWidth)
      .attr("height", plotVars.plotHeight)
      .style("background-color", "white")
      .style("border", "1px solid gray")
      //insert grid lines on mouseover
      .on("mouseover", function (d, i) {
            d3.select(`.y-axis-grid-${id}`).transition()
               .style("opacity", "0.8")
      })
      .on("mouseout", function (d, i) {
            d3.select(`.y-axis-grid-${id}`).transition()
               .style("opacity", "0")
      })

      svgContainer.append("g")
         .selectAll("path")
         .data(nestedData)
         .join("path")
         .attr("class", "line-chart")             
         .attr("class", "line-chart")
         .attr("stroke-width", 1)
         .attr("d", indiv_char => lineGenerator(indiv_char.values))
         .attr("fill", "none")  // Do not fill the area defined by the path
         .attr("stroke", function(indiv_char, i) {
            return `#${rainbow_colors[i]}`;// Set a color for the line (The maps for color is in 'color')
         })
         .on("mouseover", function (d, i) {
            d3.select(`.y-axis-grid-${id}`).transition()
               .style("opacity", "0.8")
         })
         .on("mouseout", function (d, i) {
               d3.select(`.y-axis-grid-${id}`).transition()
                  .style("opacity", "0")
         }); 

      // svgContainer.append("g")
      //    .selectAll("text.chapter")
      //    .data(nestedData)
      //    .join("text")
      //    .attr("class", "text-chapter")
      //    .attr("x", function(d, chapterInd) { 
      //       return xScale(chapterInd); 
      //    })
      //    .attr("y", plotVars.plotMargin - 4)
      //    .style("fill", "black")
      //    .style("font-family", "Georgia")
      //    .style("font-size", 8)
      //    .text(function(d) {
      //       if(d.chapter === 1 || d.chapter % 5 === 0) {
      //          return d.chapter;
      //       }
      //       return "";
      //    });

      drawTicks(svgContainer, yAxisGrid, yAxis, xAxis, id);
   }


   for(let i=0; i < nestedDataList.length; i++) {
      initializeSingleRender(`line-chart-${i}`, nestedDataList[i]);
   }
});

</script>

</body>
</html>